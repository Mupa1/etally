generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                 @id @default(uuid())
  nationalId              String                 @unique
  email                   String                 @unique
  phoneNumber             String?
  firstName               String
  lastName                String
  role                    UserRole               @default(field_observer)
  isActive                Boolean                @default(true)
  lastLogin               DateTime?
  failedLoginAttempts     Int                    @default(0)
  passwordHash            String
  mfaSecret               String?
  registrationStatus      UserRegistrationStatus @default(pending_approval)
  registrationSubmittedAt DateTime?              @default(now())
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  createdBy               String?
  deletedAt               DateTime?
  deletedBy               String?
  auditLogs               AuditLog[]
  submittedResults        ElectionResult[]
  createdElections        Election[]
  reportedIncidents       Incident[]
  uploadedMedia           MediaAttachment[]
  mobileDevices           MobileDevice[]
  notifications           Notification[]
  assignedObservers       ObserverAssignment[]   @relation("AssignedObservers")
  reviewedApplications    ObserverRegistration[] @relation("ReviewedApplications")
  observerProfile         ObserverRegistration?  @relation("ObserverProfile")
  passwordSetupTokens     PasswordSetupToken[]
  sessions                Session[]
  geographicScopes        UserGeographicScope[]
  userPermissions         UserPermission[]

  @@index([email])
  @@index([nationalId])
  @@index([role, isActive])
  @@index([registrationStatus])
  @@map("users")
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String   @unique
  expiresAt    DateTime
  deviceInfo   Json?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
  @@index([expiresAt])
  @@map("sessions")
}

model County {
  id                   String                 @id @default(uuid())
  code                 String                 @unique
  name                 String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  deletedAt            DateTime?
  constituencies       Constituency[]
  preferredByObservers ObserverRegistration[]
  geographicScopes     UserGeographicScope[]

  @@index([code])
  @@map("counties")
}

model Constituency {
  id                   String                 @id @default(uuid())
  code                 String                 @unique
  name                 String
  countyId             String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  deletedAt            DateTime?
  county               County                 @relation(fields: [countyId], references: [id])
  wards                ElectoralWard[]
  preferredByObservers ObserverRegistration[]
  geographicScopes     UserGeographicScope[]

  @@index([countyId])
  @@index([code])
  @@map("constituencies")
}

model ElectoralWard {
  id                   String                 @id @default(uuid())
  code                 String                 @unique
  name                 String
  constituencyId       String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  deletedAt            DateTime?
  constituency         Constituency           @relation(fields: [constituencyId], references: [id])
  preferredByObservers ObserverRegistration[]
  pollingStations      PollingStation[]
  geographicScopes     UserGeographicScope[]

  @@index([constituencyId])
  @@index([code])
  @@map("electoral_wards")
}

model PollingStation {
  id                   String                 @id @default(uuid())
  code                 String                 @unique
  name                 String
  wardId               String
  latitude             Float?
  longitude            Float?
  registeredVoters     Int                    @default(0)
  isActive             Boolean                @default(true)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  deletedAt            DateTime?
  results              ElectionResult[]
  incidents            Incident[]
  observerAssignments  ObserverAssignment[]
  preferredByObservers ObserverRegistration[]
  ward                 ElectoralWard          @relation(fields: [wardId], references: [id])

  @@index([wardId])
  @@index([code])
  @@index([isActive])
  @@map("polling_stations")
}

model Election {
  id           String            @id @default(uuid())
  electionCode String            @unique
  title        String
  electionType ElectionType
  electionDate DateTime
  status       ElectionStatus    @default(draft)
  description  String?
  createdBy    String
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  deletedAt    DateTime?
  deletedBy    String?
  contests     ElectionContest[]
  results      ElectionResult[]
  creator      User              @relation(fields: [createdBy], references: [id])

  @@index([status, electionDate])
  @@index([electionType, electionDate])
  @@index([electionCode])
  @@map("elections")
}

model ElectionContest {
  id           String           @id @default(uuid())
  electionId   String
  positionName String
  description  String?
  orderIndex   Int              @default(0)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  deletedAt    DateTime?
  candidates   Candidate[]
  election     Election         @relation(fields: [electionId], references: [id], onDelete: Cascade)
  results      ElectionResult[]

  @@index([electionId])
  @@map("election_contests")
}

model Candidate {
  id              String           @id @default(uuid())
  contestId       String
  fullName        String
  partyId         String?
  candidateNumber Int?
  biography       String?
  photoUrl        String?
  isIndependent   Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  deletedAt       DateTime?
  contest         ElectionContest  @relation(fields: [contestId], references: [id], onDelete: Cascade)
  party           PoliticalParty?  @relation(fields: [partyId], references: [id])
  results         ElectionResult[]

  @@index([contestId])
  @@index([partyId])
  @@map("candidates")
}

model PoliticalParty {
  id                 String            @id @default(uuid())
  serialNumber       String?
  certificateNumber  String            @unique
  partyName          String
  abbreviation       String?
  certificateDate    String?
  symbol             String?
  colors             String?
  postalAddress      String?
  headOfficeLocation String?
  slogan             String?
  changes            String?
  logoUrl            String?
  primaryColor       String?
  affiliation        PartyAffiliation?
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  deletedAt          DateTime?
  candidates         Candidate[]

  @@index([certificateNumber])
  @@index([abbreviation])
  @@index([isActive])
  @@index([affiliation])
  @@map("political_parties")
}

model ElectionResult {
  id                      String          @id @default(uuid())
  electionId              String
  contestId               String
  candidateId             String
  pollingStationId        String
  votes                   Int             @default(0)
  resultLevel             ResultLevel
  resultStatus            ResultStatus    @default(preliminary)
  submittedBy             String
  deviceId                String?
  latitude                Float?
  longitude               Float?
  accuracyMeters          Int?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  auditSignature          String?
  form34ANumber           String?
  form34APhotos           String[]        @default([])
  form34AUploadedAt       DateTime?
  rejectedBallots         Int?            @default(0)
  spoiltBallots           Int?            @default(0)
  submittedViaObserverApp Boolean         @default(false)
  candidate               Candidate       @relation(fields: [candidateId], references: [id])
  contest                 ElectionContest @relation(fields: [contestId], references: [id])
  election                Election        @relation(fields: [electionId], references: [id])
  pollingStation          PollingStation  @relation(fields: [pollingStationId], references: [id])
  submitter               User            @relation(fields: [submittedBy], references: [id])

  @@unique([contestId, pollingStationId, candidateId, resultLevel])
  @@index([electionId, contestId])
  @@index([pollingStationId])
  @@index([submittedBy])
  @@index([createdAt])
  @@index([resultStatus])
  @@index([form34ANumber])
  @@index([submittedViaObserverApp])
  @@map("election_results")
}

model MobileDevice {
  id             String          @id @default(uuid())
  deviceId       String          @unique
  userId         String
  deviceName     String?
  deviceModel    String?
  osVersion      String?
  appVersion     String?
  lastSync       DateTime?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  offlineActions OfflineAction[]
  syncLogs       SyncLog[]

  @@index([userId])
  @@index([deviceId])
  @@index([isActive])
  @@map("mobile_devices")
}

model SyncLog {
  id              String       @id @default(uuid())
  deviceId        String
  syncType        SyncType
  recordsSynced   Int          @default(0)
  syncStartedAt   DateTime     @default(now())
  syncCompletedAt DateTime?
  syncStatus      SyncStatus   @default(in_progress)
  errorMessage    String?
  createdAt       DateTime     @default(now())
  device          MobileDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId, syncStatus])
  @@index([syncStartedAt])
  @@map("sync_logs")
}

model OfflineAction {
  id            String       @id @default(uuid())
  deviceId      String
  actionType    String
  entityType    String
  entityData    Json
  actionStatus  ActionStatus @default(pending)
  retryCount    Int          @default(0)
  lastAttemptAt DateTime?
  errorMessage  String?
  createdAt     DateTime     @default(now())
  processedAt   DateTime?
  device        MobileDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId, actionStatus])
  @@index([actionStatus, createdAt])
  @@map("offline_actions")
}

model AuditLog {
  id            String      @id @default(uuid())
  action        AuditAction
  entityType    String
  entityId      String
  userId        String
  oldValues     Json?
  newValues     Json?
  ipAddress     String?
  userAgent     String?
  deviceId      String?
  latitude      Float?
  longitude     Float?
  requestId     String?
  correlationId String?
  createdAt     DateTime    @default(now())
  user          User        @relation(fields: [userId], references: [id])

  @@index([userId, entityType, entityId])
  @@index([action, createdAt])
  @@index([correlationId])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

model Notification {
  id          String               @id @default(uuid())
  userId      String
  title       String
  message     String
  type        NotificationType
  priority    NotificationPriority @default(medium)
  actionUrl   String?
  actionLabel String?
  isRead      Boolean              @default(false)
  sentAt      DateTime             @default(now())
  readAt      DateTime?
  createdAt   DateTime             @default(now())
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@index([userId, type])
  @@map("notifications")
}

model MediaAttachment {
  id                 String       @id @default(uuid())
  entityType         String
  entityId           String
  fileName           String
  filePath           String
  fileSize           BigInt
  mimeType           String
  thumbnailPath      String?
  uploadedBy         String
  deviceId           String?
  latitude           Float?
  longitude          Float?
  uploadStatus       UploadStatus @default(pending)
  processingMetadata Json?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  uploader           User         @relation(fields: [uploadedBy], references: [id])

  @@index([entityType, entityId])
  @@index([uploadStatus])
  @@index([uploadedBy])
  @@map("media_attachments")
}

model Incident {
  id               String           @id @default(uuid())
  title            String
  description      String
  severity         IncidentSeverity
  status           IncidentStatus   @default(reported)
  pollingStationId String?
  latitude         Float?
  longitude        Float?
  reportedBy       String
  deviceId         String?
  resolvedBy       String?
  resolutionNotes  String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  resolvedAt       DateTime?
  pollingStation   PollingStation?  @relation(fields: [pollingStationId], references: [id])
  reporter         User             @relation(fields: [reportedBy], references: [id])

  @@index([pollingStationId])
  @@index([reportedBy])
  @@index([status, severity])
  @@index([createdAt])
  @@map("incidents")
}

model RateLimit {
  id           String    @id @default(uuid())
  identifier   String
  endpoint     String
  requestCount Int       @default(0)
  windowStart  DateTime  @default(now())
  blockedUntil DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([identifier, endpoint, windowStart])
  @@index([identifier, windowStart])
  @@index([blockedUntil])
  @@map("rate_limits")
}

model Configuration {
  id           String            @id @default(uuid())
  key          String            @unique
  name         String
  description  String?
  value        String?
  type         ConfigurationType @default(string)
  category     String
  isRequired   Boolean           @default(false)
  isDefault    Boolean           @default(false)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  lastModified DateTime          @default(now())
  modifiedBy   String?

  @@index([category])
  @@index([key])
  @@map("configurations")
}

model UserGeographicScope {
  id             String         @id @default(uuid())
  userId         String
  countyId       String?
  constituencyId String?
  wardId         String?
  scopeLevel     String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  constituency   Constituency?  @relation(fields: [constituencyId], references: [id])
  county         County?        @relation(fields: [countyId], references: [id])
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  ward           ElectoralWard? @relation(fields: [wardId], references: [id])

  @@unique([userId, countyId, constituencyId, wardId])
  @@index([userId])
  @@map("user_geographic_scopes")
}

model AccessPolicy {
  id           String             @id @default(uuid())
  name         String
  description  String?
  effect       PolicyEffect       @default(allow)
  priority     Int                @default(0)
  roles        UserRole[]
  resourceType ResourceType
  actions      PermissionAction[]
  conditions   Json?
  isActive     Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  createdBy    String

  @@index([resourceType, isActive])
  @@index([priority])
  @@map("access_policies")
}

model UserPermission {
  id           String           @id @default(uuid())
  userId       String
  resourceType ResourceType
  resourceId   String?
  action       PermissionAction
  effect       PolicyEffect     @default(allow)
  expiresAt    DateTime?
  reason       String?
  grantedBy    String
  createdAt    DateTime         @default(now())
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceType, resourceId, action])
  @@index([userId, resourceType])
  @@index([expiresAt])
  @@map("user_permissions")
}

model PermissionCheck {
  id           String           @id @default(uuid())
  userId       String
  resourceType ResourceType
  resourceId   String?
  action       PermissionAction
  granted      Boolean
  reason       String?
  ipAddress    String?
  deviceId     String?
  latitude     Float?
  longitude    Float?
  checkedAt    DateTime         @default(now())

  @@index([userId, checkedAt])
  @@index([resourceType, action])
  @@map("permission_checks")
}

model ObserverRegistration {
  id                      String               @id @default(uuid())
  nationalId              String               @unique
  firstName               String
  lastName                String
  dateOfBirth             DateTime
  phoneNumber             String
  email                   String               @unique
  preferredCountyId       String?
  preferredConstituencyId String?
  preferredWardId         String?
  preferredStationId      String?
  nationalIdFrontUrl      String?
  nationalIdBackUrl       String?
  profilePhotoUrl         String?
  additionalDocs          String[]
  status                  ObserverStatus       @default(pending_review)
  trackingNumber          String               @unique
  submissionDate          DateTime             @default(now())
  reviewDate              DateTime?
  reviewedBy              String?
  reviewNotes             String?
  rejectionReason         String?
  userId                  String?              @unique
  termsAccepted           Boolean              @default(false)
  dataProcessingConsent   Boolean              @default(false)
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  assignments             ObserverAssignment[]
  preferredConstituency   Constituency?        @relation(fields: [preferredConstituencyId], references: [id])
  preferredCounty         County?              @relation(fields: [preferredCountyId], references: [id])
  preferredStation        PollingStation?      @relation(fields: [preferredStationId], references: [id])
  preferredWard           ElectoralWard?       @relation(fields: [preferredWardId], references: [id])
  reviewer                User?                @relation("ReviewedApplications", fields: [reviewedBy], references: [id])
  user                    User?                @relation("ObserverProfile", fields: [userId], references: [id])

  @@index([nationalId])
  @@index([email])
  @@index([status])
  @@index([trackingNumber])
  @@index([submissionDate])
  @@map("observer_registrations")
}

model ObserverAssignment {
  id                     String               @id @default(uuid())
  observerRegistrationId String
  pollingStationId       String
  assignmentDate         DateTime             @default(now())
  assignedBy             String
  isActive               Boolean              @default(true)
  deactivatedAt          DateTime?
  deactivatedBy          String?
  deactivationReason     String?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  assigner               User                 @relation("AssignedObservers", fields: [assignedBy], references: [id])
  observerRegistration   ObserverRegistration @relation(fields: [observerRegistrationId], references: [id], onDelete: Cascade)
  pollingStation         PollingStation       @relation(fields: [pollingStationId], references: [id])

  @@unique([observerRegistrationId, pollingStationId])
  @@index([pollingStationId])
  @@index([isActive])
  @@map("observer_assignments")
}

model PasswordSetupToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_setup_tokens")
}

enum UserRole {
  super_admin
  election_manager
  field_observer
  public_viewer
}

enum Gender {
  male
  female
  other
}

enum ElectionType {
  general_election
  by_election
  referendum
}

enum ElectionStatus {
  draft
  scheduled
  active
  paused
  completed
  cancelled
}

enum ResultLevel {
  polling_station
  ward
  constituency
  county
  national
}

enum ResultStatus {
  preliminary
  verified
  confirmed
  disputed
}

enum AuditAction {
  create
  update
  delete
  login
  logout
  export
}

enum SyncType {
  full_sync
  incremental_sync
  media_sync
}

enum SyncStatus {
  in_progress
  completed
  failed
  cancelled
}

enum ActionStatus {
  pending
  processing
  completed
  failed
}

enum NotificationType {
  system_alert
  result_update
  assignment
  security
}

enum NotificationPriority {
  low
  medium
  high
  critical
}

enum ObserverStatus {
  pending_review
  approved
  active
  rejected
  suspended
  inactive
}

enum UploadStatus {
  pending
  processing
  completed
  failed
}

enum IncidentSeverity {
  low
  medium
  high
  critical
}

enum IncidentStatus {
  reported
  investigating
  resolved
  dismissed
}

enum UserRegistrationStatus {
  pending_approval
  approved
  rejected
}

enum PartyAffiliation {
  main_party
  friendly_party
  competitor
}

enum PermissionAction {
  create
  read
  update
  delete
  approve
  verify
  export
  submit
}

enum ResourceType {
  election
  election_contest
  candidate
  election_result
  incident
  user
  audit_log
  polling_station
  observer
}

enum PolicyEffect {
  allow
  deny
}

enum ConfigurationType {
  string
  number
  boolean
  json
}
